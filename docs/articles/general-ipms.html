<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>General IPMs • ipmr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="General IPMs">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ipmr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ipmr-introduction.html">Introduction to ipmr</a>
    </li>
    <li>
      <a href="../articles/general-ipms.html">General IPMs</a>
    </li>
    <li>
      <a href="../articles/index-notation.html">Index Notation in ipmr</a>
    </li>
    <li>
      <a href="../articles/age_x_size.html">Age X Size IPMs</a>
    </li>
    <li>
      <a href="../articles/density-dependence.html">Density/Frequency Dependent IPMs</a>
    </li>
    <li>
      <a href="../articles/proto-ipms.html">proto_ipm Data Structure</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/padrinoDB/ipmr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>General IPMs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/padrinoDB/ipmr/blob/main/vignettes/general-ipms.Rmd" class="external-link"><code>vignettes/general-ipms.Rmd</code></a></small>
      <div class="hidden name"><code>general-ipms.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="simple-ipms-vs-general-ipms">Simple IPMs vs General IPMs<a class="anchor" aria-label="anchor" href="#simple-ipms-vs-general-ipms"></a>
</h2>
<p>In the <a href="https://padrinoDB.github.io/ipmr/articles/ipmr-introduction.html" class="external-link">introduction
vignette</a>, we reviewed some basic IPM theory and worked through
examples of simple IPMs, which only model a single, continuously
distributed state variable. General IPMs are distinguished from simple
ones in that they incorporate multiple state variables and/or include
transitions between continuous and discrete states. These state
variables could be, for example, a continuous measure of coral colony
surface area and a discrete state to denote aspergillosis infection (in
<a href="https://esajournals.onlinelibrary.wiley.com/doi/full/10.1890/09-1178.1" class="external-link">Bruno
et al. 2011</a>), a mixture of trees classified by basal diameter and a
discrete state for seeds in a seed bank (in <a href="https://besjournals.onlinelibrary.wiley.com/doi/10.1111/1365-2664.13020" class="external-link">Crandall
&amp; Knight 2017</a>), or a mixture of multiple continuous and discrete
state (e.g. <a href="https://esajournals.onlinelibrary.wiley.com/doi/pdf/10.1890/13-1478.1" class="external-link">Aikens
&amp; Roach 2014</a>). A more comprehensive definition is provided in <a href="https://pubmed.ncbi.nlm.nih.gov/16673349/" class="external-link">Ellner &amp; Rees
(2006)</a> and in Ellner, Childs &amp; Rees, Chapter 6 (2016).</p>
</div>
<div class="section level2">
<h2 id="a-general-density-independent-deterministic-ipm">A general, density independent, deterministic IPM<a class="anchor" aria-label="anchor" href="#a-general-density-independent-deterministic-ipm"></a>
</h2>
<p>We’ll start with the least complicated of the general IPMs and build
progressively from there. If you’ve already read through the
introduction vignette, then most of this will look pretty familiar. If
not, it is probably best to at least skim the first few sections before
proceeding here.</p>
<div class="section level3">
<h3 id="key-differences-between-simple-and-general-ipms-">Key differences between simple and general IPMs.<a class="anchor" aria-label="anchor" href="#key-differences-between-simple-and-general-ipms-"></a>
</h3>
<p>As noted above, we are now working with models that may have multiple
continuous state variables and/or discrete states to describe the
demography of our species. Thus, we need to add some more information to
the model’s definition in order to fully capture these additional
demographic details.</p>
<p>Relative to how we define simple models in <code>ipmr</code>, there
are now two new bits:</p>
<ol style="list-style-type: decimal">
<li><p>Each kernel that has an integration requires that
<code>d_statevariable</code> get appended to the kernel
<code>formula</code>. This is equivalent to the “dz” in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∫</mo><mi>L</mi><mi>U</mi></msubsup><mi>K</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>,</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi mathvariant="normal">d</mi><mi mathvariant="normal">z</mi></mrow></mrow><annotation encoding="application/x-tex">\int_L^U K(z',z) n(z,t) \mathrm{dz}</annotation></semantics></math>.
<code>ipmr</code> automatically generates this variable internally, so
there is no need to define it in the <code>data_list</code> or
<code><a href="../reference/define_star.html">define_domains()</a></code>, we can just add it any of the formula(s)
that we want to. We skipped this step in the simple IPMs because it gets
appended automatically. Unfortunately, it is less easy to infer the
correct state variable to <code>d_z</code> with for general IPMs where
there may be many continuous and/or discrete states.</p></li>
<li><p>The implementation arguments list can now have different values
in the <code>state_start</code> and <code>state_end</code> slots. This
is demonstrated in a separate chunk below.</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="mathematical-overview-of-the-example">Mathematical overview of the example<a class="anchor" aria-label="anchor" href="#mathematical-overview-of-the-example"></a>
</h3>
<p>This example will use an IPM for <em>Ligustrum obtusifolium</em>, a
tree species that is now invasive in North America. Data were collected
outside of St. Louis, Missouri, and the full model is described in <a href="https://esajournals.onlinelibrary.wiley.com/action/downloadSupplement?doi=10.1002%2Fecy.2681&amp;file=ecy2681-sup-0002-MetadataS1.pdf" class="external-link">Levin
et al. 2019</a>. The IPM consists of a single discrete stage (seed bank,
abbreviated <code>b</code>) and a single continuous state (height,
abbreviated
<code>ht</code>/<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo>,</mo><mi>z</mi><mi>′</mi></mrow><annotation encoding="application/x-tex">z,z'</annotation></semantics></math>).
The census timing was such that all seeds must enter the seed bank. They
can either germinate in the next year, or they can die (so
<code>stay_discrete</code> = 0). Thus, the full model takes the
following form:</p>
<ol style="list-style-type: decimal">
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mo>∫</mo><mi>L</mi><mi>U</mi></msubsup><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>,</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi mathvariant="normal">z</mi><mo>+</mo><mi>b</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><mi>l</mi><mi>e</mi><mi>a</mi><mi>v</mi><mi>e</mi><mi>_</mi><mi>d</mi><mi>i</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>t</mi><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">n(z', t + 1) = \int_L^U P(z', z) n(z,t)d\mathrm{z} + b(t) * leave\_discrete(z')</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mo>∫</mo><mi>L</mi><mi>U</mi></msubsup><mi>g</mi><mi>o</mi><mi>_</mi><mi>d</mi><mi>i</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>t</mi><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>,</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi mathvariant="normal">z</mi><mo>+</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>y</mi><mi>_</mi><mi>d</mi><mi>i</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>t</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">b(t + 1) = \int_L^Ugo\_discrete(z) n(z,t)d\mathrm{z}+ stay\_discrete</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><mi>G</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(z',z) = s(z) * G(z',z)</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>o</mi><mi>_</mi><mi>d</mi><mi>i</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>t</mi><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>f</mi><mi>s</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><msub><mi>f</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><msub><mi>g</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">go\_discrete(z) = f_s(z) * f_r(z) * g_i</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>e</mi><mi>a</mi><mi>v</mi><mi>e</mi><mi>_</mi><mi>d</mi><mi>i</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>t</mi><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>e</mi><mi>p</mi></msub><mo>*</mo><msub><mi>f</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">leave\_discrete(z') = e_p * f_d(z')</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>y</mi><mi>_</mi><mi>d</mi><mi>i</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>t</mi><mi>e</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">stay\_discrete = 0</annotation></semantics></math></p></li>
</ol>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>G</mi></msub><annotation encoding="application/x-tex">f_G</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><msub><mi>r</mi><mi>d</mi></msub></msub><annotation encoding="application/x-tex">f_{r_d}</annotation></semantics></math>
denote Normal probability density functions. The vital rates functions
and example code to fit them are:</p>
<ol style="list-style-type: decimal">
<li>
<p>survival (<code>s</code>): A logistic regression with a squared
term</p>
<ul>
<li><p>Example code:
<code>glm(surv ~ ht_1 + I(ht_1)^2, data = my_surv_data, family = binomial())</code></p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>t</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>α</mi><mi>s</mi></msub><mo>+</mo><msub><mi>β</mi><mrow><mi>s</mi><mo>,</mo><mn>1</mn></mrow></msub><mo>*</mo><mi>z</mi><mo>+</mo><msub><mi>β</mi><mrow><mi>s</mi><mo>,</mo><mn>2</mn></mrow></msub><mo>*</mo><msup><mi>z</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">Logit(s(z)) = \alpha_s + \beta_{s,1} * z + \beta_{s,2} * z^2</annotation></semantics></math></p></li>
</ul>
</li>
<li>
<p>growth (<code>g</code>): A linear regression</p>
<ul>
<li><p>example code:
<code>lm(ht_2 ~ ht_1, data = grow_data)</code></p></li>
<li>
<p>Mathematical form:</p>
<ul>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>G</mi></msub><mo>=</mo><msub><mi>α</mi><mi>G</mi></msub><mo>+</mo><msub><mi>β</mi><mi>G</mi></msub><mo>*</mo><mi>z</mi></mrow><annotation encoding="application/x-tex">\mu_G = \alpha_G + \beta_G * z</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>f</mi><mi>G</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mi>G</mi></msub><mo>,</mo><msub><mi>σ</mi><mi>G</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">G(z',z) = f_G(\mu_G, \sigma_G)</annotation></semantics></math></p></li>
</ul>
</li>
</ul>
</li>
<li>
<p>flowering probability (<code>r_r</code>): A logistic
regression</p>
<ul>
<li><p>example code:
<code>glm(repro ~ ht_1, data = my_repro_data, family = binomial())</code></p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>t</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>α</mi><msub><mi>r</mi><mi>r</mi></msub></msub><mo>+</mo><msub><mi>β</mi><msub><mi>r</mi><mi>r</mi></msub></msub><mo>*</mo><mi>z</mi></mrow><annotation encoding="application/x-tex">Logit(r_r(z)) = \alpha_{r_r} + \beta_{r_r} * z</annotation></semantics></math></p></li>
</ul>
</li>
<li>
<p>seed production (<code>r_s</code>): A Poisson regression</p>
<ul>
<li><p>example code:
<code>glm(seeds ~ ht_1, data = my_seed_data, family = poisson())</code></p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>s</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>α</mi><msub><mi>r</mi><mi>s</mi></msub></msub><mo>+</mo><msub><mi>β</mi><msub><mi>r</mi><mi>s</mi></msub></msub><mo>*</mo><mi>z</mi></mrow><annotation encoding="application/x-tex">Log(r_s(z)) = \alpha_{r_s} + \beta_{r_s} * z</annotation></semantics></math></p></li>
</ul>
</li>
<li>
<p>Recruit size distribution (<code>r_d</code>): A normal
distribution with mean <code>r_d_mu</code> and standard deviation
<code>r_d_sd</code>.</p>
<ul>
<li><p>example code:
<code>r_d_mu &lt;- mean(my_recr_data$ht_2, na.rm = TRUE)</code> and
<code>r_d_sd &lt;- sd(my_rer_data$ht_2, na.rm = TRUE)</code>.</p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>f</mi><msub><mi>r</mi><mi>d</mi></msub></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><msub><mi>r</mi><mi>d</mi></msub></msub><mo>,</mo><msub><mi>σ</mi><msub><mi>r</mi><mi>d</mi></msub></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">r_d(z') = f_{r_d}(\mu_{r_d}, \sigma_{r_d})</annotation></semantics></math></p></li>
</ul>
</li>
<li>
<p>germination (<code>g_i</code>) and establishment
(<code>e_p</code>) are constants. The code below assumes we have our
data in long format (each seed get its own row) and that successful
germination/establishment is coded as 1s, failures are 0s, and seeds we
don’t know the fate of for whatever reason are <code>NA</code>s.</p>
<ul>
<li><p>example code:
<code>g_i &lt;- mean(my_germ_data, na.rm = TRUE)</code> and
<code>e_p &lt;- mean(my_est_data, na.rm = TRUE)</code></p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mi>i</mi></msub><mo>=</mo><mn>0.5067</mn><mo>,</mo><msub><mi>e</mi><mi>p</mi></msub><mo>=</mo><mn>0.15</mn></mrow><annotation encoding="application/x-tex">g_i = 0.5067, e_p = 0.15</annotation></semantics></math></p></li>
</ul>
</li>
</ol>
</div>
<div class="section level3">
<h3 id="model-code">Model code<a class="anchor" aria-label="anchor" href="#model-code"></a>
</h3>
<p>Below is the code to implement this model. First, we define our our
parameters in a list.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://padrinoDB.github.io/ipmr/" class="external-link">ipmr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set up the initial population conditions and parameters</span></span>
<span></span>
<span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  g_int     <span class="op">=</span> <span class="fl">5.781</span>,</span>
<span>  g_slope   <span class="op">=</span> <span class="fl">0.988</span>,</span>
<span>  g_sd      <span class="op">=</span> <span class="fl">20.55699</span>,</span>
<span>  s_int     <span class="op">=</span> <span class="op">-</span><span class="fl">0.352</span>,</span>
<span>  s_slope   <span class="op">=</span> <span class="fl">0.122</span>,</span>
<span>  s_slope_2 <span class="op">=</span> <span class="op">-</span><span class="fl">0.000213</span>,</span>
<span>  r_r_int   <span class="op">=</span> <span class="op">-</span><span class="fl">11.46</span>,</span>
<span>  r_r_slope <span class="op">=</span> <span class="fl">0.0835</span>,</span>
<span>  r_s_int   <span class="op">=</span> <span class="fl">2.6204</span>,</span>
<span>  r_s_slope <span class="op">=</span> <span class="fl">0.01256</span>,</span>
<span>  r_d_mu    <span class="op">=</span> <span class="fl">5.6655</span>,</span>
<span>  r_d_sd    <span class="op">=</span> <span class="fl">2.0734</span>,</span>
<span>  e_p       <span class="op">=</span> <span class="fl">0.15</span>,</span>
<span>  g_i       <span class="op">=</span> <span class="fl">0.5067</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Next, we set up two functions to pass into the model. These perform
the inverse logit transformations for the probability of flowering model
(<code>r_r</code>/<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">r_r(z)</annotation></semantics></math>)
and survival model
(<code>s</code>/<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">s(z)</annotation></semantics></math>).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We'll set up some helper functions. The survival function</span></span>
<span><span class="co"># in this model is a quadratic function, so we use an additional inverse logit function</span></span>
<span><span class="co"># that can handle the quadratic term.</span></span>
<span></span>
<span><span class="va">inv_logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">inv_logit_2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">slope_2</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">+</span> <span class="va">slope_2</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now, we’re ready to begin making the IPM kernels. We change the
<code>sim_gen</code> argument of <code><a href="../reference/init_ipm.html">init_ipm()</a></code> to
<code>"general"</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">general_ipm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init_ipm.html">init_ipm</a></span><span class="op">(</span>sim_gen <span class="op">=</span> <span class="st">"general"</span>, di_dd <span class="op">=</span> <span class="st">"di"</span>, det_stoch <span class="op">=</span> <span class="st">"det"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name          <span class="op">=</span> <span class="st">"P"</span>,</span>
<span>    </span>
<span>    <span class="co"># We add d_ht to formula to make sure integration is handled correctly.</span></span>
<span>    <span class="co"># This variable is generated internally by make_ipm(), so we don't need</span></span>
<span>    <span class="co"># to do anything else.</span></span>
<span>    </span>
<span>    formula       <span class="op">=</span> <span class="va">s</span> <span class="op">*</span> <span class="va">g</span> <span class="op">*</span> <span class="va">d_ht</span>,</span>
<span>    </span>
<span>    <span class="co"># The family argument tells ipmr what kind of transition this kernel describes.</span></span>
<span>    <span class="co"># it can be "CC" for continuous -&gt; continuous, "DC" for discrete -&gt; continuous</span></span>
<span>    <span class="co"># "CD" for continuous -&gt; discrete, or "DD" for discrete -&gt; discrete.</span></span>
<span>    </span>
<span>    family        <span class="op">=</span> <span class="st">"CC"</span>,</span>
<span>    </span>
<span>    <span class="co"># The rest of the arguments are exactly the same as in the simple models</span></span>
<span>    </span>
<span>    g             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">g_mu</span>, <span class="va">g_sd</span><span class="op">)</span>,</span>
<span>    g_mu          <span class="op">=</span> <span class="va">g_int</span> <span class="op">+</span> <span class="va">g_slope</span> <span class="op">*</span> <span class="va">ht_1</span>,</span>
<span>    s             <span class="op">=</span> <span class="fu">inv_logit_2</span><span class="op">(</span><span class="va">s_int</span>, <span class="va">s_slope</span>, <span class="va">s_slope_2</span>, <span class="va">ht_1</span><span class="op">)</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">data_list</span>,</span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/eviction.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,</span>
<span>                                            <span class="st">'g'</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name          <span class="op">=</span> <span class="st">"go_discrete"</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">r_r</span> <span class="op">*</span> <span class="va">r_s</span> <span class="op">*</span> <span class="va">d_ht</span>,</span>
<span>    </span>
<span>    <span class="co"># Note that now, family = "CD" because it denotes a continuous -&gt; discrete transition</span></span>
<span>    </span>
<span>    family        <span class="op">=</span> <span class="st">'CD'</span>,</span>
<span>    r_r           <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">r_r_int</span>, <span class="va">r_r_slope</span>, <span class="va">ht_1</span><span class="op">)</span>,</span>
<span>    r_s           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">r_s_int</span> <span class="op">+</span> <span class="va">r_s_slope</span> <span class="op">*</span> <span class="va">ht_1</span><span class="op">)</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">data_list</span>,</span>
<span>    </span>
<span>    <span class="co"># Note that here, we add "b" to our list in states, because this kernel</span></span>
<span>    <span class="co"># "creates" seeds entering the seedbank</span></span>
<span>    </span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name    <span class="op">=</span> <span class="st">'stay_discrete'</span>,</span>
<span>    </span>
<span>    <span class="co"># In this case, seeds in the seed bank either germinate or die, but they </span></span>
<span>    <span class="co"># do not remain for multiple time steps. This can be adjusted as needed.</span></span>
<span>    </span>
<span>    formula <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    </span>
<span>    <span class="co"># Note that now, family = "DD" because it denotes a discrete -&gt; discrete transition</span></span>
<span>    </span>
<span>    family  <span class="op">=</span> <span class="st">"DD"</span>,</span>
<span>    </span>
<span>    <span class="co"># The only state variable this operates on is "b", so we can leave "ht"</span></span>
<span>    <span class="co"># out of the states list</span></span>
<span>    </span>
<span>    states  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'b'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    evict_cor <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="co"># Here, the family changes to "DC" because it is the discrete -&gt; continuous </span></span>
<span>    <span class="co"># transition</span></span>
<span>    </span>
<span>    name          <span class="op">=</span> <span class="st">'leave_discrete'</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">e_p</span> <span class="op">*</span> <span class="va">g_i</span> <span class="op">*</span> <span class="va">r_d</span>,</span>
<span>    r_d           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">r_d_mu</span>, <span class="va">r_d_sd</span><span class="op">)</span>,</span>
<span>    family        <span class="op">=</span> <span class="st">'DC'</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">data_list</span>,</span>
<span>    </span>
<span>    <span class="co"># Again, we need to add "b" to the states list</span></span>
<span>    </span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/eviction.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,</span>
<span>                                            <span class="st">'r_d'</span><span class="op">)</span></span>
<span>  <span class="op">)</span> </span></code></pre></div>
<p>We’ve now defined all of the kernels, next are the implementation
details. These also differ somewhat from simple IPMs. The key difference
in the implementation arguments list lies in the
<code>state_start</code> and <code>state_end</code> of each kernel, and
is related to the <code>family</code> argument of each kernel. Kernels
that begin with one state and end in a different state (e.g. moving from
seed bank to a plant) will have different entries in the
<code>state_start</code> and <code>state_end</code> slots. It is very
important to get these correct, as <code>ipmr</code> uses this
information to generate the model iteration procedure automatically
(i.e. code corresponding to Equations 1-2).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">general_ipm</span> <span class="op">&lt;-</span> <span class="va">general_ipm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_impl</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      P              <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>int_rule    <span class="op">=</span> <span class="st">"midpoint"</span>,</span>
<span>                            state_start <span class="op">=</span> <span class="st">"ht"</span>,</span>
<span>                            state_end   <span class="op">=</span> <span class="st">"ht"</span><span class="op">)</span>,</span>
<span>      go_discrete    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>int_rule    <span class="op">=</span> <span class="st">"midpoint"</span>,</span>
<span>                            state_start <span class="op">=</span> <span class="st">"ht"</span>,</span>
<span>                            state_end   <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>      stay_discrete  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>int_rule    <span class="op">=</span> <span class="st">"midpoint"</span>,</span>
<span>                            state_start <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>                            state_end   <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span>,</span>
<span>      leave_discrete <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>int_rule    <span class="op">=</span> <span class="st">"midpoint"</span>,</span>
<span>                            state_start <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>                            state_end   <span class="op">=</span> <span class="st">"ht"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>An alternative to the list above is to use
<code><a href="../reference/define_star.html">make_impl_args_list()</a></code>. The chunk above and the chunk below
generate equivalent <code>proto_ipm</code> objects.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">general_ipm</span> <span class="op">&lt;-</span> <span class="va">general_ipm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_impl</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/define_star.html">make_impl_args_list</a></span><span class="op">(</span></span>
<span>      kernel_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"P"</span>, <span class="st">"go_discrete"</span>, <span class="st">"stay_discrete"</span>, <span class="st">"leave_discrete"</span><span class="op">)</span>,</span>
<span>      int_rule     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"midpoint"</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      state_start    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"ht"</span>, <span class="st">"b"</span>, <span class="st">"b"</span><span class="op">)</span>,</span>
<span>      state_end      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">'ht'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The rest is the same as the simple IPM. We can use our pre-defined
functions in <code>make_ipm</code>, and we can use pre-defined variables
in <code>define_domains</code>. We’ll create variables for the upper
(<code>U</code>) and lower (<code>L</code>) size bounds for the
population, and the number of meshpoints for integration
(<code>n</code>). We also define initial population vectors for both
<code>b</code> and <code>ht</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The lower and upper bounds for the continuous state variable and the number</span></span>
<span><span class="co"># of meshpoints for the midpoint rule integration. We'll also create the initial</span></span>
<span><span class="co"># population vector from a random uniform distribution</span></span>
<span></span>
<span><span class="va">L</span> <span class="op">&lt;-</span> <span class="fl">1.02</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="fl">624</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2312</span><span class="op">)</span></span>
<span></span>
<span><span class="va">init_pop_vec</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">init_seed_bank</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span></span>
<span></span>
<span><span class="va">general_ipm</span> <span class="op">&lt;-</span> <span class="va">general_ipm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_domains</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="co"># We can pass the variables we created above into define_domains</span></span>
<span>    </span>
<span>    ht <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">L</span>, <span class="va">U</span>, <span class="va">n</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_pop_state</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="co"># We can also pass them into define_pop_state</span></span>
<span>    </span>
<span>    pop_vectors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_ht <span class="op">=</span> <span class="va">init_pop_vec</span>,</span>
<span>      n_b  <span class="op">=</span> <span class="va">init_seed_bank</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span><span class="op">(</span>iterations <span class="op">=</span> <span class="fl">100</span>,</span>
<span>           usr_funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>inv_logit   <span class="op">=</span> <span class="va">inv_logit</span>,</span>
<span>                           inv_logit_2 <span class="op">=</span> <span class="va">inv_logit_2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># lambda is a generic function to compute per-capita growth rates. It has a number</span></span>
<span><span class="co"># of different options depending on the type of model</span></span>
<span></span>
<span><span class="fu"><a href="../reference/lambda.html">lambda</a></span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># If we are worried about whether or not the model converged to stable</span></span>
<span><span class="co"># dynamics, we can use the exported utility is_conv_to_asymptotic. The default</span></span>
<span><span class="co"># tolerance for convergence is 1e-10, but can be changed with the 'tol' argument.</span></span>
<span></span>
<span><span class="fu"><a href="../reference/check_convergence.html">is_conv_to_asymptotic</a></span><span class="op">(</span><span class="va">general_ipm</span>, tol <span class="op">=</span> <span class="fl">1e-10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eigenvectors.html">right_ev</a></span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eigenvectors.html">left_ev</a></span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span></span></code></pre></div>
<p>Our model is now built! We can explore the asymptotic population
growth rate with the <code><a href="../reference/lambda.html">lambda()</a></code> function, which will work on
any object made my <code><a href="../reference/make_ipm.html">make_ipm()</a></code>. The same is true for
<code><a href="../reference/check_convergence.html">is_conv_to_asymptotic()</a></code>, which is a helper to function to
figure out if we’ve set the number of <code>iterations</code> high
enough to actually reach asymptotic population dynamics.
<code>left_ev</code> and <code>right_ev</code> work for general
deterministic IPMs as well. Stochastic versions are in the works, but
are not yet implemented.</p>
</div>
<div class="section level3">
<h3 id="further-analysis">Further analysis<a class="anchor" aria-label="anchor" href="#further-analysis"></a>
</h3>
<p>Say we wanted to calculate the mean and variance of life span
conditional on initial state
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>z</mi><mn>0</mn></msub><annotation encoding="application/x-tex">z_0</annotation></semantics></math>.
This requires us to generate the IPM’s fundamental operator,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>,
which is computed as follows:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>−</mo><mi>P</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">N = (I - P)^{-1}</annotation></semantics></math>.
The following chunk is a function to compute average lifespan as a
function of initial size. Note that we omit the fecundity from these
calculations entirely, as our model does not assume that reproduction
imposes a cost on survival.</p>
<p>The formula for mean lifespan is given as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>η</mi><mo accent="true">‾</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>z</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>e</mi><mi>N</mi></mrow><annotation encoding="application/x-tex">\bar{\eta}(z_0) = eN</annotation></semantics></math>
(where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>e</mi><annotation encoding="application/x-tex">e</annotation></semantics></math>
is a constant function such that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>≡</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">e(z)\equiv1</annotation></semantics></math>),
and the formula for its variance is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mi>η</mi><mn>2</mn></msubsup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>z</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><msup><mi>N</mi><mn>2</mn></msup><mo>−</mo><mi>N</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>e</mi><mi>N</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sigma^2_\eta(z_0) = e(2N^2-N) - (eN)^2</annotation></semantics></math>.
Since the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>e</mi><annotation encoding="application/x-tex">e</annotation></semantics></math>
function has the effect of summing columns, we’ll replace that with the
<em>R</em> function <code>colSums</code>. Our second function,
<code>sigma_eta</code>, will make use of <code>%^%</code> from
<code>ipmr</code>, which multiples matrices by themselves, rather than
the point-wise power provided by <code>^</code>. More details on the
math underlying these calculations are provided in Ellner, Childs, &amp;
Rees (2016), chapter 3.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_N</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">P</span>     <span class="op">&lt;-</span> <span class="va">ipm</span><span class="op">$</span><span class="va">sub_kernels</span><span class="op">$</span><span class="va">P</span></span>
<span>  </span>
<span>  <span class="va">I</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">P</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">N</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">I</span> <span class="op">-</span> <span class="va">P</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">eta_bar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">N</span>     <span class="op">&lt;-</span> <span class="fu">make_N</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span></span>
<span>  <span class="va">out</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">sigma_eta</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">N</span>     <span class="op">&lt;-</span> <span class="fu">make_N</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span>  </span>
<span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="va">N</span> <span class="op"><a href="../reference/matrix-power.html">%^%</a></span> <span class="fl">2L</span><span class="op">)</span> <span class="op">-</span> <span class="va">N</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mean_l</span> <span class="op">&lt;-</span> <span class="fu">eta_bar</span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span></span>
<span><span class="va">var_l</span>  <span class="op">&lt;-</span> <span class="fu">sigma_eta</span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mesh_ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/accessors.html">int_mesh</a></span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span><span class="op">$</span><span class="va">ht_1</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mesh_ps</span>, <span class="va">mean_l</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span> <span class="st">"Initial size z"</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mesh_ps</span>, <span class="va">var_l</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span> <span class="st">"Initial size z"</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>From prior knowledge, we happen to know that even in the best
conditions, <em>Ligustrum obtusifolium</em> individuals usually only
live 25-50 years. It appears that our model (wildly) overestimates their
average lifespan, and we’d want to think about how to re-parameterize it
to more accurately capture mortality events. Our survival model would
seem the most likely candidate for re-examination, particularly for
young and mid-sized trees. That is a problem for another day though, and
so the next section will investigate how to implement general IPMs in
discretely varying environments.</p>
</div>
</div>
<div class="section level2">
<h2 id="general-models-for-discretely-varying-environments">General models for discretely varying environments<a class="anchor" aria-label="anchor" href="#general-models-for-discretely-varying-environments"></a>
</h2>
<p>Discretely varying parameters can be used to construct general IPMs
with little additional effort. These are typically the result of fitting
a set of fixed effects vital rate models that include both continuous
predictors for size/state and categorical variables like treatment or
maturation state. They can also result from mixed effects models, for
example, working with conditional modes for a random intercept
corresponding to year or site.</p>
<p><code>ipmr</code> refers to these as <em>parameter sets</em>, and
abbreviates them <code>par_sets</code>. For example, a random intercept
for year may be denoted
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>α</mi><mrow><mi>y</mi><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">\alpha_{yr}</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi></mi><mrow><mi>y</mi><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">_{yr}</annotation></semantics></math>
provides an index for the different values that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
can take on.</p>
<p>If you’ve already read the Intro to <code>ipmr</code> article and the
example above, then there aren’t any new concepts to introduce here.
Below is an example showing how all of these come together.</p>
<div class="section level3">
<h3 id="mathematical-overview-of-the-example-1">Mathematical overview of the example<a class="anchor" aria-label="anchor" href="#mathematical-overview-of-the-example-1"></a>
</h3>
<p>We’ll use a variation of the model above, simulating some random
year-specific intercepts for growth and seed production. Parameters,
functions, and kernels that are now time varying have a subscript
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mrow><mi>y</mi><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">x_{yr}</annotation></semantics></math>
appended to them.</p>
<ol style="list-style-type: decimal">
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mo>∫</mo><mi>L</mi><mi>U</mi></msubsup><msub><mi>P</mi><mrow><mi>y</mi><mi>r</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>,</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi mathvariant="normal">z</mi><mo>+</mo><mi>b</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><mi>l</mi><mi>e</mi><mi>a</mi><mi>v</mi><mi>e</mi><mi>_</mi><mi>d</mi><mi>i</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>t</mi><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">n(z', t + 1) = \int_L^U P_{yr}(z', z) n(z,t)d\mathrm{z} + b(t) * leave\_discrete(z')</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mo>∫</mo><mi>L</mi><mi>U</mi></msubsup><mi>g</mi><mi>o</mi><mi>_</mi><mi>d</mi><mi>i</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>t</mi><msub><mi>e</mi><mrow><mi>y</mi><mi>r</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>,</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi mathvariant="normal">z</mi><mo>+</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>y</mi><mi>_</mi><mi>d</mi><mi>i</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>t</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">b(t + 1) = \int_L^Ugo\_discrete_{yr}(z) n(z,t)d\mathrm{z}+ stay\_discrete</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>y</mi><mi>r</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><msub><mi>G</mi><mrow><mi>y</mi><mi>r</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P_{yr}(z',z) = s(z) * G_{yr}(z',z)</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mi>o</mi><mi>_</mi><mi>d</mi><mi>i</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>t</mi><msub><mi>e</mi><mrow><mi>y</mi><mi>r</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>r</mi><mrow><mi>s</mi><mo>,</mo><mi>y</mi><mi>r</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><msub><mi>r</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><msub><mi>g</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">go\_discrete_{yr}(z) = r_{s,yr}(z) * r_r(z) * g_i</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>e</mi><mi>a</mi><mi>v</mi><mi>e</mi><mi>_</mi><mi>d</mi><mi>i</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>t</mi><mi>e</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>e</mi><mi>p</mi></msub><mo>*</mo><msub><mi>r</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">leave\_discrete(z') = e_p * r_d(z')</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>y</mi><mi>_</mi><mi>d</mi><mi>i</mi><mi>s</mi><mi>c</mi><mi>r</mi><mi>e</mi><mi>t</mi><mi>e</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">stay\_discrete = 0</annotation></semantics></math></p></li>
</ol>
<p>The vital rate models are as follows:</p>
<ol style="list-style-type: decimal">
<li>
<p>survival (<code>s</code>): A logistic regression</p>
<ul>
<li><p>Example code:
<code>glm(surv ~ ht_1, data = my_surv_data, family = binomial())</code></p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>t</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>α</mi><mi>s</mi></msub><mo>+</mo><msub><mi>β</mi><mrow><mi>s</mi><mo>,</mo><mn>1</mn></mrow></msub><mo>*</mo><mi>z</mi><mo>+</mo><msub><mi>β</mi><mrow><mi>s</mi><mo>,</mo><mn>2</mn></mrow></msub><mo>*</mo><msup><mi>z</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">Logit(s(z)) = \alpha_s + \beta_{s,1} * z + \beta_{s,2} * z^2</annotation></semantics></math></p></li>
</ul>
</li>
<li>
<p>growth (<code>g</code>): A linear mixed effects regression.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>G</mi></msub><annotation encoding="application/x-tex">f_G</annotation></semantics></math>
denotes a normal probability density function.</p>
<ul>
<li><p>example code:
<code>lmer(ht_2 ~ ht_1 + (1 | year), data = grow_data)</code></p></li>
<li>
<p>Mathematical form:</p>
<ul>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mrow><mi>G</mi><mo>,</mo><mi>y</mi><mi>r</mi></mrow></msub><mo>=</mo><msub><mi>α</mi><mi>G</mi></msub><mo>+</mo><msub><mi>α</mi><mrow><mi>G</mi><mo>,</mo><mi>y</mi><mi>r</mi></mrow></msub><mo>+</mo><msub><mi>β</mi><mi>G</mi></msub><mo>*</mo><mi>z</mi></mrow><annotation encoding="application/x-tex">\mu_{G,yr} = \alpha_G + \alpha_{G,yr} + \beta_G * z</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mrow><mi>y</mi><mi>r</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>f</mi><mi>G</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><msub><mi>μ</mi><mrow><mi>G</mi><mo>,</mo><mi>y</mi><mi>r</mi></mrow></msub><mo>,</mo><msub><mi>σ</mi><mi>G</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">G_{yr}(z',z) = f_G(z', \mu_{G,yr}, \sigma_G)</annotation></semantics></math></p></li>
</ul>
</li>
</ul>
</li>
<li>
<p>flowering probability (<code>r_r</code>): A logistic
regression</p>
<ul>
<li><p>example code:
<code>glm(repro ~ ht_1, data = my_repro_data, family = binomial())</code></p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>t</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>α</mi><msub><mi>r</mi><mi>r</mi></msub></msub><mo>+</mo><msub><mi>β</mi><msub><mi>r</mi><mi>r</mi></msub></msub><mo>*</mo><mi>z</mi></mrow><annotation encoding="application/x-tex">Logit(r_r(z)) = \alpha_{r_r} + \beta_{r_r} * z</annotation></semantics></math></p></li>
</ul>
</li>
<li>
<p>seed production (<code>r_s</code>): A Poisson mixed effects
regression</p>
<ul>
<li><p>example code:
<code>glmer(seeds ~ ht_1 + (1 | year), data = my_seed_data, family = poisson())</code></p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>r</mi><mrow><mi>s</mi><mo>,</mo><mi>y</mi><mi>r</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>α</mi><msub><mi>r</mi><mi>s</mi></msub></msub><mo>+</mo><msub><mi>α</mi><mrow><msub><mi>r</mi><mi>s</mi></msub><mo>,</mo><mi>y</mi><mi>r</mi></mrow></msub><mo>+</mo><msub><mi>β</mi><msub><mi>r</mi><mi>s</mi></msub></msub><mo>*</mo><mi>z</mi></mrow><annotation encoding="application/x-tex">Log(r_{s,yr}(z)) = \alpha_{r_s} + \alpha_{r_s, yr} + \beta_{r_s} * z</annotation></semantics></math></p></li>
</ul>
</li>
<li>
<p>Recruit size distribution (<code>r_d</code>): A normal
distribution
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><msub><mi>r</mi><mi>d</mi></msub></msub><annotation encoding="application/x-tex">f_{r_d}</annotation></semantics></math>)
with mean <code>r_d_mu</code> and standard deviation
<code>r_d_sd</code>.</p>
<ul>
<li><p>example code:
<code>r_d_mu &lt;- mean(my_recr_data$ht_2, na.rm = TRUE)</code> and
<code>r_d_sd &lt;- sd(my_recr_data$ht_2, na.rm = TRUE)</code>.</p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>f</mi><msub><mi>r</mi><mi>d</mi></msub></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><msub><mi>μ</mi><msub><mi>r</mi><mi>d</mi></msub></msub><mo>,</mo><msub><mi>σ</mi><msub><mi>r</mi><mi>d</mi></msub></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">r_d(z') = f_{r_d}(z', \mu_{r_d}, \sigma_{r_d})</annotation></semantics></math></p></li>
</ul>
</li>
<li>
<p>germination (<code>g_i</code>) and establishment
(<code>e_p</code>) are constants. The code below assumes we have our
data in long format (each seed get its own row) and that successful
germinations/establishments are coded as 1s, failures are 0s, and seeds
we don’t know the fate of for whatever reason are <code>NA</code>s.</p>
<ul>
<li><p>example code:
<code>g_i &lt;- mean(my_germ_data, na.rm = TRUE)</code> and
<code>e_p &lt;- mean(my_est_data, na.rm = TRUE)</code></p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mi>i</mi></msub><mo>=</mo><mn>0.5067</mn><mo>,</mo><msub><mi>e</mi><mi>p</mi></msub><mo>=</mo><mn>0.15</mn></mrow><annotation encoding="application/x-tex">g_i = 0.5067, e_p = 0.15</annotation></semantics></math></p></li>
</ul>
</li>
</ol>
</div>
<div class="section level3">
<h3 id="model-parameterization">Model parameterization<a class="anchor" aria-label="anchor" href="#model-parameterization"></a>
</h3>
<p>In the next chunk, we’ll set up the data list with all of our
constants and make sure the names are what we want them to be. This
example generates intercepts for 5 years of data. This can be altered
according to your own needs. Then, we’ll define a couple functions to
make the vital rate expressions easier to write.</p>
<p>A key aspect here is setting the names on the time-varying parameters
in the <code>data_list</code>. We are using the form
<code>"g_int_year"</code>, and substituting the values that
<code>"year"</code> can take in for the actual index. These don’t need
to be numbers, they can be words, letters, or some combination of the
two. For this example, the years will be represented with the values
<code>1:5</code>. If we wanted to denote the actual years of the
censuses, we could switch <code>1:5</code> to, for example,
<code>2002:2006</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://padrinoDB.github.io/ipmr/" class="external-link">ipmr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set up the initial population conditions and parameters</span></span>
<span><span class="co"># Here, we are simulating random intercepts for growth</span></span>
<span><span class="co"># and seed production, converting them to a list,</span></span>
<span><span class="co"># and adding them into the list of constants. Equivalent code</span></span>
<span><span class="co"># to produce the output for the output from lmer/glmer</span></span>
<span><span class="co"># is in the comments next to each line</span></span>
<span></span>
<span><span class="va">all_g_int</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, mean <span class="op">=</span> <span class="fl">5.781</span>, sd <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="co"># as.list(unlist(ranef(my_growth_model)))</span></span>
<span><span class="va">all_r_s_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, mean <span class="op">=</span> <span class="fl">2.6204</span>, sd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="co"># as.list(unlist(ranef(my_seed_model)))</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">all_g_int</span><span class="op">)</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"g_int_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">all_r_s_int</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"r_s_int_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="va">constant_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  g_slope   <span class="op">=</span> <span class="fl">0.988</span>,</span>
<span>  g_sd      <span class="op">=</span> <span class="fl">20.55699</span>,</span>
<span>  s_int     <span class="op">=</span> <span class="op">-</span><span class="fl">0.352</span>,</span>
<span>  s_slope   <span class="op">=</span> <span class="fl">0.122</span>,</span>
<span>  s_slope_2 <span class="op">=</span> <span class="op">-</span><span class="fl">0.000213</span>,</span>
<span>  r_r_int   <span class="op">=</span> <span class="op">-</span><span class="fl">11.46</span>,</span>
<span>  r_r_slope <span class="op">=</span> <span class="fl">0.0835</span>,</span>
<span>  r_s_slope <span class="op">=</span> <span class="fl">0.01256</span>,</span>
<span>  r_d_mu    <span class="op">=</span> <span class="fl">5.6655</span>,</span>
<span>  r_d_sd    <span class="op">=</span> <span class="fl">2.0734</span>,</span>
<span>  e_p       <span class="op">=</span> <span class="fl">0.15</span>,</span>
<span>  g_i       <span class="op">=</span> <span class="fl">0.5067</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">all_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">constant_list</span>, <span class="va">all_g_int</span>, <span class="va">all_r_s_int</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The lower and upper bounds for the continuous state variable and the number</span></span>
<span><span class="co"># of meshpoints for the midpoint rule integration.</span></span>
<span></span>
<span><span class="va">L</span> <span class="op">&lt;-</span> <span class="fl">1.02</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="fl">624</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2312</span><span class="op">)</span></span>
<span></span>
<span><span class="va">init_pop_vec</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">init_seed_bank</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span></span>
<span><span class="co"># add some helper functions. The survival function</span></span>
<span><span class="co"># in this model is a quadratic function, so we use an additional inverse logit function</span></span>
<span><span class="co"># that can handle the quadratic term.</span></span>
<span></span>
<span><span class="va">inv_logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">inv_logit_2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">slope_2</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">+</span> <span class="va">slope_2</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Next, we will set up our sub-kernels. We’ll append the
<code>_year</code> suffix to the kernel <code>name</code>, the vital
rate expressions and parameter values that have time-varying components
(<code>g_year</code>, <code>f_s_year</code>, <code>g_int_year</code>,
<code>f_s_int_year</code>), and the call to
<code>truncated_distributions</code> so that the growth kernel is
correctly specified. We’ll also pass a <code>list(year = 1:5))</code>
into the <code>par_set_indices</code> argument of
<code><a href="../reference/kernel-definitions.html">define_kernel()</a></code>. When building the model,
<code><a href="../reference/make_ipm.html">make_ipm()</a></code> automatically expands these expressions to
create 5 different expressions containing the various levels of
<code>year</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">general_stoch_kern_ipm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init_ipm.html">init_ipm</a></span><span class="op">(</span>sim_gen    <span class="op">=</span> <span class="st">"general"</span>,</span>
<span>                                   di_dd      <span class="op">=</span> <span class="st">"di"</span>, </span>
<span>                                   det_stoch  <span class="op">=</span> <span class="st">"stoch"</span>,</span>
<span>                                   kern_param <span class="op">=</span> <span class="st">"kern"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="co"># The kernel name gets indexed by _year to denote that there</span></span>
<span>    <span class="co"># are multiple possible kernels we can build with our parameter set.</span></span>
<span>    <span class="co"># The _year gets substituted by the values in "par_set_indices" in the </span></span>
<span>    <span class="co"># output, so in this example we will have P_1, P_2, P_3, P_4, and P_5</span></span>
<span>    </span>
<span>    name          <span class="op">=</span> <span class="st">"P_year"</span>,</span>
<span>    </span>
<span>    <span class="co"># We also add _year to "g" to signify that it is going to vary across kernels.</span></span>
<span>    </span>
<span>    formula       <span class="op">=</span> <span class="va">s</span> <span class="op">*</span> <span class="va">g_year</span> <span class="op">*</span> <span class="va">d_ht</span>,</span>
<span>    family        <span class="op">=</span> <span class="st">"CC"</span>,</span>
<span>    </span>
<span>    <span class="co"># Here, we add the suffixes again, ensuring they are expanded and replaced</span></span>
<span>    <span class="co"># during model building by the parameter names</span></span>
<span>    </span>
<span>    g_year           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">g_mu_year</span>, <span class="va">g_sd</span><span class="op">)</span>,</span>
<span>    g_mu_year        <span class="op">=</span> <span class="va">g_int_year</span> <span class="op">+</span> <span class="va">g_slope</span> <span class="op">*</span> <span class="va">ht_1</span>,</span>
<span>    s                <span class="op">=</span> <span class="fu">inv_logit_2</span><span class="op">(</span><span class="va">s_int</span>, <span class="va">s_slope</span>, <span class="va">s_slope_2</span>, <span class="va">ht_1</span><span class="op">)</span>,</span>
<span>    data_list        <span class="op">=</span> <span class="va">all_params</span>,</span>
<span>    states           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># We set uses_par_sets to TRUE, signalling that we want to expand these</span></span>
<span>    <span class="co"># expressions across all levels of par_set_indices.</span></span>
<span>    </span>
<span>    uses_par_sets    <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    par_set_indices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>    evict_cor        <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    </span>
<span>    <span class="co"># we also add the suffix to `target` here, because the value modified by </span></span>
<span>    <span class="co"># truncated_distributions is time-varying.</span></span>
<span>    </span>
<span>    evict_fun        <span class="op">=</span> <span class="fu"><a href="../reference/eviction.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,</span>
<span>                                               target <span class="op">=</span> <span class="st">'g_year'</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="co"># again, we append the index to the kernel name, vital rate expressions,</span></span>
<span>    <span class="co"># and in the model formula.</span></span>
<span>    </span>
<span>    name          <span class="op">=</span> <span class="st">"go_discrete_year"</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">r_r</span> <span class="op">*</span> <span class="va">r_s_year</span> <span class="op">*</span> <span class="va">g_i</span> <span class="op">*</span> <span class="va">d_ht</span>,</span>
<span>    family        <span class="op">=</span> <span class="st">'CD'</span>,</span>
<span>    r_r           <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">r_r_int</span>, <span class="va">r_r_slope</span>, <span class="va">ht_1</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># Again, we modify the left and right hand side of this expression to </span></span>
<span>    <span class="co"># show that there is a time-varying component</span></span>
<span>    </span>
<span>    r_s_year      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">r_s_int_year</span> <span class="op">+</span> <span class="va">r_s_slope</span> <span class="op">*</span> <span class="va">ht_1</span><span class="op">)</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">all_params</span>,</span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets    <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    par_set_indices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="co"># This kernel has no time-varying parameters, and so is not indexed.</span></span>
<span>    </span>
<span>    name    <span class="op">=</span> <span class="st">'stay_discrete'</span>,</span>
<span>    </span>
<span>    <span class="co"># In this case, seeds in the seed bank either germinate or die, but they </span></span>
<span>    <span class="co"># do not remain for multipe time steps. This can be adjusted as needed.</span></span>
<span>    </span>
<span>    formula <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    </span>
<span>    <span class="co"># Note that now, family = "DD" becuase it denotes a discrete -&gt; discrete transition</span></span>
<span>    </span>
<span>    family  <span class="op">=</span> <span class="st">"DD"</span>,</span>
<span>    states  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'b'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    </span>
<span>    <span class="co"># This kernel has no time-varying parameters, so we don't need to designate</span></span>
<span>    <span class="co"># it as such.</span></span>
<span>    </span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    evict_cor <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span></span>
<span>    <span class="co"># This kernel also doesn't get a index, because there are no varying parameters.</span></span>
<span>    </span>
<span>    name          <span class="op">=</span> <span class="st">'leave_discrete'</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">e_p</span> <span class="op">*</span> <span class="va">r_d</span>,</span>
<span>    r_d           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">r_d_mu</span>, <span class="va">r_d_sd</span><span class="op">)</span>,</span>
<span>    family        <span class="op">=</span> <span class="st">'DC'</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">all_params</span>,</span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/eviction.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,</span>
<span>                                            <span class="st">'r_d'</span><span class="op">)</span></span>
<span>  <span class="op">)</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_impl</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/define_star.html">make_impl_args_list</a></span><span class="op">(</span></span>
<span>      </span>
<span>      <span class="co"># We add suffixes to the kernel names here to make sure they match the names</span></span>
<span>      <span class="co"># we specified above.</span></span>
<span>      </span>
<span>      kernel_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"P_year"</span>, <span class="st">"go_discrete_year"</span>, <span class="st">"stay_discrete"</span>, <span class="st">"leave_discrete"</span><span class="op">)</span>,</span>
<span>      int_rule     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"midpoint"</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      state_start    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"ht"</span>, <span class="st">"b"</span>, <span class="st">"b"</span><span class="op">)</span>,</span>
<span>      state_end      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">'ht'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_domains</a></span><span class="op">(</span></span>
<span>    ht <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">L</span>, <span class="va">U</span>, <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_pop_state</a></span><span class="op">(</span></span>
<span>      n_ht <span class="op">=</span> <span class="va">init_pop_vec</span>,</span>
<span>      n_b  <span class="op">=</span> <span class="va">init_seed_bank</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span><span class="op">(</span></span>
<span>    iterations <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    </span>
<span>    <span class="co"># We can specify a sequence of kernels to select for the simulation.</span></span>
<span>    <span class="co"># This helps others to reproduce what we did,</span></span>
<span>    <span class="co"># and lets us keep track of the consequences of different selection</span></span>
<span>    <span class="co"># sequences for population dynamics. </span></span>
<span>    </span>
<span>    kernel_seq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, size <span class="op">=</span> <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    usr_funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>inv_logit   <span class="op">=</span> <span class="va">inv_logit</span>,</span>
<span>                    inv_logit_2 <span class="op">=</span> <span class="va">inv_logit_2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>100 isn’t too many iterations, but hopefully this demonstrates how to
set up and implement such a model. There are a number of slots in the
output that may be useful for further analyses.</p>
<ol style="list-style-type: decimal">
<li><p><code>env_seq</code>: This contains a character vector which
shows the sequence in which levels of the time-varying components were
chosen during model iteration. We could use this to reproduce the model
outputs later.</p></li>
<li><p><code>pop_state$lambda</code>: This shows the single timestep
per-capita growth rates for the simulation.</p></li>
</ol>
<p>Additionally, there are functions to compute the stochastic
population growth rate
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>λ</mi><mi>s</mi></msub><annotation encoding="application/x-tex">\lambda_s</annotation></semantics></math>,
computed as <code>mean(log(pop_state$lambda))</code>, burn in can be
controlled with the <code>burn_in</code> parameter), and the mean
sub-kernels.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_kernels</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mean_kernel.html">mean_kernel</a></span><span class="op">(</span><span class="va">general_stoch_kern_ipm</span><span class="op">)</span></span>
<span><span class="va">lam_s</span>        <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lambda.html">lambda</a></span><span class="op">(</span><span class="va">general_stoch_kern_ipm</span>, burn_in <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span> <span class="co"># Remove first 15% of iterations</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="general-models-with-continuously-varying-environments">General models with continuously varying environments<a class="anchor" aria-label="anchor" href="#general-models-with-continuously-varying-environments"></a>
</h2>
<p>We can also use continuously varying parameters to construct general
IPMs. These are good tools for exploring the consequences of
environmental variation on demographic rates. <code>ipmr</code> handles
these using <code><a href="../reference/define_star.html">define_env_state()</a></code>, which can take both
functions and data and generate draws from distributions during each
iteration of the model.</p>
<div class="section level3">
<h3 id="mathematical-overview">Mathematical overview<a class="anchor" aria-label="anchor" href="#mathematical-overview"></a>
</h3>
<p>This example includes survival and growth models that make use of
environmental covariates. The model can be written as:</p>
<ol style="list-style-type: decimal">
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msubsup><mo>∫</mo><mi>L</mi><mi>U</mi></msubsup><mi>K</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>,</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi>z</mi><mo>+</mo><mi>B</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><msub><mi>r</mi><mi>s</mi></msub><mo>*</mo><msub><mi>r</mi><mi>d</mi></msub><mo>*</mo><msub><mi>f</mi><msub><mi>c</mi><mi>d</mi></msub></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">n(z', t+1) = \int_L^U K(z',z, \theta)n(z,t)dz + B(t) * r_s * r_d * f_{c_d}(z')</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>r</mi><mi>e</mi></msub><mo>*</mo><msub><mi>r</mi><mi>s</mi></msub><mo>*</mo><msubsup><mo>∫</mo><mi>L</mi><mi>U</mi></msubsup><msub><mi>c</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><msub><mi>c</mi><mi>s</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>,</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>d</mi><mi>z</mi><mo>+</mo><mi>B</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><msub><mi>r</mi><mi>s</mi></msub><mo>*</mo><msub><mi>r</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">B(t + 1) = r_e * r_s * \int_L^U c_r(z) * c_s(z)n(z,t)dz + B(t) * r_s * r_r</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">K(z',z,\theta) = P(z',z,\theta) + F(z',z)</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><mi>G</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">P(z',z,\theta) = s(z, \theta) * G(z',z,\theta)</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>c</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><msub><mi>c</mi><mi>s</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><msub><mi>c</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><msub><mi>r</mi><mi>e</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">F(z',z) = c_r(z) * c_s(z) * c_d(z') * (1 - r_e)</annotation></semantics></math></p></li>
</ol>
<p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>θ</mi><annotation encoding="application/x-tex">\theta</annotation></semantics></math>
is a vector of time-varying environmental parameters. For this example,
we’ll use a Gaussian distribution for temperature and a Gamma
distribution for precipitation:</p>
<ol start="6" style="list-style-type: decimal">
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>t</mi></msub><mo>∼</mo><mi>N</mi><mi>o</mi><mi>r</mi><mi>m</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>μ</mi><mo>=</mo><mn>8.9</mn><mo>,</mo><mi>σ</mi><mo>=</mo><mn>1.2</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\theta_t \sim Norm(\mu = 8.9, \sigma = 1.2)</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>p</mi></msub><mo>∼</mo><mi>G</mi><mi>a</mi><mi>m</mi><mi>m</mi><mi>a</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>k</mi><mo>=</mo><mn>1000</mn><mo>,</mo><mi>β</mi><mo>=</mo><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\theta_p \sim Gamma(k =  1000, \beta = 2)</annotation></semantics></math></p></li>
</ol>
<p>Next, we’ll write out the actual vital rate functions in the
model:</p>
<ol start="8" style="list-style-type: decimal">
<li>
<p>survival
(<code>s</code>/<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">s(z,\theta)</annotation></semantics></math>):
a logistic regression.</p>
<ul>
<li><p>Example model formula:
<code>glm(survival ~ size_1 + temp + precip, data = my_surv_data, family = binomial())</code></p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>t</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>s</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>α</mi><mi>s</mi></msub><mo>+</mo><msubsup><mi>β</mi><mi>s</mi><mi>z</mi></msubsup><mo>*</mo><mi>z</mi><mo>+</mo><msubsup><mi>β</mi><mi>s</mi><mi>t</mi></msubsup><mo>*</mo><mi>t</mi><mi>e</mi><mi>m</mi><mi>p</mi><mo>+</mo><msubsup><mi>β</mi><mi>s</mi><mi>p</mi></msubsup><mo>*</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>i</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">Logit(s(z,\theta)) = \alpha_s + \beta_s^z * z + \beta_s^t * temp + \beta_s^p * precip</annotation></semantics></math></p></li>
</ul>
</li>
<li>
<p>growth (<code>g</code>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">G(z',z,\theta)</annotation></semantics></math>):
a linear regression with a Normal error distribution (denoted
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>G</mi></msub><annotation encoding="application/x-tex">f_G</annotation></semantics></math>)</p>
<ul>
<li><p>Example model formula:
<code>glm(size_2 ~ size_1 + temp + precip, data = my_grow_data)</code></p></li>
<li>
<p>Mathematical form:</p>
<ul>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>f</mi><mi>G</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><msub><mi>μ</mi><mi>G</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msub><mi>σ</mi><mi>G</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">G(z',z) = f_G(z', \mu_G(z,\theta), \sigma_G)</annotation></semantics></math></p></li>
<li><p><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>G</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo>,</mo><mi>θ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>α</mi><mi>G</mi></msub><mo>+</mo><msubsup><mi>β</mi><mi>G</mi><mi>z</mi></msubsup><mo>*</mo><mi>z</mi><mo>+</mo><msubsup><mi>β</mi><mi>G</mi><mi>t</mi></msubsup><mo>*</mo><mi>t</mi><mi>e</mi><mi>m</mi><mi>p</mi><mo>+</mo><msubsup><mi>β</mi><mi>G</mi><mi>p</mi></msubsup><mo>*</mo><mi>p</mi><mi>r</mi><mi>e</mi><mi>c</mi><mi>i</mi><mi>p</mi></mrow><annotation encoding="application/x-tex">\mu_G(z, \theta) = \alpha_G + \beta_G^z * z + \beta_G^t * temp + \beta_G^p * precip</annotation></semantics></math></p></li>
</ul>
</li>
</ul>
</li>
<li>
<p>flower probability
(<code>c_r</code>/<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">c_r(z)</annotation></semantics></math>):
A logistic regression.</p>
<ul>
<li><p>Example model formula:
<code>glm(repro ~ size_1, data = my_repro_data, family = binomial())</code></p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mi>i</mi><mi>t</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>c</mi><mi>r</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>α</mi><mi>c</mi></msub><mo>+</mo><msub><mi>β</mi><msub><mi>c</mi><mi>r</mi></msub></msub><mo>*</mo><mi>z</mi></mrow><annotation encoding="application/x-tex">Logit(c_r(z)) = \alpha_{c} + \beta_{c_r} * z</annotation></semantics></math></p></li>
</ul>
</li>
<li>
<p>seed production
(<code>c_s</code>/<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>s</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">c_s(z)</annotation></semantics></math>:
a logistic regression.</p>
<ul>
<li><p>Example model formula:
<code>glm(flower_n ~ size_1, data = my_flower_data, family = poisson())</code></p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>c</mi><mi>s</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>α</mi><msub><mi>c</mi><mi>s</mi></msub></msub><mo>+</mo><msub><mi>β</mi><msub><mi>c</mi><mi>s</mi></msub></msub><mo>*</mo><mi>z</mi></mrow><annotation encoding="application/x-tex">Log(c_s(z)) = \alpha_{c_s} + \beta_{c_s} * z</annotation></semantics></math></p></li>
</ul>
</li>
<li>
<p>recruit sizes
(<code>c_d</code>/<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">c_d(z')</annotation></semantics></math>):
A Normal distribution (denoted
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><msub><mi>c</mi><mi>d</mi></msub></msub><annotation encoding="application/x-tex">f_{c_d}</annotation></semantics></math>)</p>
<ul>
<li><p>Example code: mean (<code>c_d_mu</code>)
<code>mean(my_recruit_data$size_2, na.rm = TRUE)</code> and standard
deviation (<code>c_d_sd</code>)
<code>sd(my_recruit_data$size_2, na.rm = TRUE)</code></p></li>
<li><p>Mathematical form:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>d</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>f</mi><msub><mi>c</mi><mi>d</mi></msub></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><msub><mi>μ</mi><msub><mi>f</mi><mi>d</mi></msub></msub><mo>,</mo><msub><mi>σ</mi><msub><mi>f</mi><mi>d</mi></msub></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">c_d(z') = f_{c_d}(z', \mu_{f_d}, \sigma_{f_d})</annotation></semantics></math></p></li>
</ul>
</li>
<li><p>Constants: Discrete stage survival (<code>r_s</code>), discrete
stage entrance probability (<code>r_e</code>), discrete stage departure
probability conditional on survival (<code>r_d</code>), and probability
of remaining in discrete stage (<code>r_r</code>).</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="model-parameterization-1">Model parameterization<a class="anchor" aria-label="anchor" href="#model-parameterization-1"></a>
</h3>
<p>First, we’ll specify the constant parameters. We keep all values
related to demography in the <code>data_list</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://padrinoDB.github.io/ipmr/" class="external-link">ipmr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define the fixed parameters in a list</span></span>
<span></span>
<span><span class="va">constant_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  s_int     <span class="op">=</span> <span class="op">-</span><span class="fl">5</span>,</span>
<span>  s_slope   <span class="op">=</span> <span class="fl">2.2</span>,</span>
<span>  s_precip  <span class="op">=</span> <span class="fl">0.0002</span>,</span>
<span>  s_temp    <span class="op">=</span> <span class="op">-</span><span class="fl">0.003</span>,</span>
<span>  g_int     <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  g_slope   <span class="op">=</span> <span class="fl">1.01</span>,</span>
<span>  g_sd      <span class="op">=</span> <span class="fl">1.2</span>,</span>
<span>  g_temp    <span class="op">=</span> <span class="op">-</span><span class="fl">0.002</span>,</span>
<span>  g_precip  <span class="op">=</span> <span class="fl">0.004</span>,</span>
<span>  c_r_int   <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  c_r_slope <span class="op">=</span> <span class="fl">0.03</span>,</span>
<span>  c_s_int   <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>  c_s_slope <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>  c_d_mu    <span class="op">=</span> <span class="fl">1.1</span>,</span>
<span>  c_d_sd    <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  r_e       <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  r_d       <span class="op">=</span> <span class="fl">0.3</span>,</span>
<span>  r_r       <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  r_s       <span class="op">=</span> <span class="fl">0.2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In addition to creating the standard <code>data_list</code>, we need
to create a function to sample the environmental covariates, and a list
of parameters that generate the environmental covariates. The function
needs to return a named list. The names in the returned list can be
referenced in vital rate expressions, kernel formulas, etc. as if we had
specified them in the <code>data_list</code>. <code><a href="../reference/make_ipm.html">make_ipm()</a></code>
only runs the functions in <code><a href="../reference/define_star.html">define_env_state()</a></code> once per
model iteration. This ensures that parameters from joint distributions
can be used consistently across kernels without losing user-any
specified correlations.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Now, we create a set of environmental covariates. In this example, we use</span></span>
<span><span class="co"># a normal distribution for temperature and a Gamma for precipitation. </span></span>
<span></span>
<span><span class="va">env_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  temp_mu <span class="op">=</span> <span class="fl">8.9</span>,</span>
<span>  temp_sd <span class="op">=</span> <span class="fl">1.2</span>,</span>
<span>  precip_shape <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  precip_rate  <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We define a wrapper function that samples from these distributions</span></span>
<span></span>
<span><span class="va">sample_env</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">env_params</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># We generate one value for each covariate per iteration, and return it </span></span>
<span>  <span class="co"># as a named list. </span></span>
<span>  </span>
<span>  <span class="va">temp_now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>,</span>
<span>                    <span class="va">env_params</span><span class="op">$</span><span class="va">temp_mu</span>, </span>
<span>                    <span class="va">env_params</span><span class="op">$</span><span class="va">temp_sd</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">precip_now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">rgamma</a></span><span class="op">(</span><span class="fl">1</span>, </span>
<span>                       shape <span class="op">=</span> <span class="va">env_params</span><span class="op">$</span><span class="va">precip_shape</span>,</span>
<span>                       rate <span class="op">=</span> <span class="va">env_params</span><span class="op">$</span><span class="va">precip_rate</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># The vital rate expressions can now use the names "temp" and "precip" </span></span>
<span>  <span class="co"># as if they were in the data_list.</span></span>
<span>  </span>
<span>  <span class="va">out</span>        <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>temp <span class="op">=</span> <span class="va">temp_now</span>, precip <span class="op">=</span> <span class="va">precip_now</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Again, we can define our own functions and pass them into calls to make_ipm. This</span></span>
<span><span class="co"># isn't strictly necessary, but can make the model code more readable/less error prone.</span></span>
<span></span>
<span><span class="va">inv_logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lin_term</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">lin_term</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-specification">Model specification<a class="anchor" aria-label="anchor" href="#model-specification"></a>
</h3>
<p>We are now ready to begin implementing the model. This next chunk
should look familiar, with the caveat that we have now add the terms
<code>temp</code> and <code>precip</code> to vital rates in the
<code>P</code> kernel.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">general_stoch_param_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init_ipm.html">init_ipm</a></span><span class="op">(</span>sim_gen    <span class="op">=</span> <span class="st">"general"</span>,</span>
<span>                                      di_dd      <span class="op">=</span> <span class="st">"di"</span>, </span>
<span>                                      det_stoch  <span class="op">=</span> <span class="st">"stoch"</span>,</span>
<span>                                      kern_param <span class="op">=</span> <span class="st">"param"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name       <span class="op">=</span> <span class="st">"P_stoch"</span>,</span>
<span>    family     <span class="op">=</span> <span class="st">"CC"</span>,</span>
<span>    </span>
<span>    <span class="co"># As in the examples above, we have to add the d_surf_area</span></span>
<span>    <span class="co"># to ensure the integration of the functions is done.</span></span>
<span>    </span>
<span>    formula    <span class="op">=</span> <span class="va">s</span> <span class="op">*</span> <span class="va">g</span> <span class="op">*</span> <span class="va">d_surf_area</span>,</span>
<span>    </span>
<span>    <span class="co"># We can reference continuously varying parameters by name</span></span>
<span>    <span class="co"># in the vital rate expressions just as before, even though</span></span>
<span>    <span class="co"># they are passed in define_env_state() as opposed to the kernel's</span></span>
<span>    <span class="co"># data_list</span></span>
<span>    </span>
<span>    g_mu    <span class="op">=</span> <span class="va">g_int</span> <span class="op">+</span> <span class="va">g_slope</span> <span class="op">*</span> <span class="va">surf_area_1</span> <span class="op">+</span> <span class="va">g_temp</span> <span class="op">*</span> <span class="va">temp</span> <span class="op">+</span> <span class="va">g_precip</span> <span class="op">*</span> <span class="va">precip</span>,</span>
<span>    s_lin_p <span class="op">=</span> <span class="va">s_int</span> <span class="op">+</span> <span class="va">s_slope</span> <span class="op">*</span> <span class="va">surf_area_1</span> <span class="op">+</span> <span class="va">s_temp</span> <span class="op">*</span> <span class="va">temp</span> <span class="op">+</span> <span class="va">s_precip</span> <span class="op">*</span> <span class="va">precip</span>,</span>
<span>    s       <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">s_lin_p</span><span class="op">)</span>,</span>
<span>    g       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">surf_area_2</span>, <span class="va">g_mu</span>, <span class="va">g_sd</span><span class="op">)</span>,</span>
<span>   </span>
<span>    data_list     <span class="op">=</span> <span class="va">constant_params</span>,</span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"surf_area"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/eviction.html">truncated_distributions</a></span><span class="op">(</span><span class="st">"norm"</span>, <span class="st">"g"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name          <span class="op">=</span> <span class="st">"F"</span>,</span>
<span>    family        <span class="op">=</span> <span class="st">"CC"</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">c_r</span> <span class="op">*</span> <span class="va">c_s</span> <span class="op">*</span> <span class="va">c_d</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">r_e</span><span class="op">)</span> <span class="op">*</span> <span class="va">d_surf_area</span>,</span>
<span>    </span>
<span>    c_r_lin_p     <span class="op">=</span> <span class="va">c_r_int</span> <span class="op">+</span> <span class="va">c_r_slope</span> <span class="op">*</span> <span class="va">surf_area_1</span>,</span>
<span>    c_r           <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">c_r_lin_p</span><span class="op">)</span>,</span>
<span>    c_s           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">c_s_int</span> <span class="op">+</span> <span class="va">c_s_slope</span> <span class="op">*</span> <span class="va">surf_area_1</span><span class="op">)</span>,</span>
<span>    c_d           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">surf_area_2</span>, <span class="va">c_d_mu</span>, <span class="va">c_d_sd</span><span class="op">)</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">constant_params</span>,</span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"surf_area"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/eviction.html">truncated_distributions</a></span><span class="op">(</span><span class="st">"norm"</span>, <span class="st">"c_d"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    </span>
<span>    <span class="co"># Name can be anything, but it helps to make sure they're descriptive</span></span>
<span>    </span>
<span>    name <span class="op">=</span> <span class="st">"go_discrete"</span>,</span>
<span>    </span>
<span>    <span class="co"># Family is now "CD" because it is a continuous -&gt; discrete transition</span></span>
<span>    </span>
<span>    family        <span class="op">=</span> <span class="st">"CD"</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">r_e</span> <span class="op">*</span> <span class="va">r_s</span> <span class="op">*</span> <span class="va">c_r</span> <span class="op">*</span> <span class="va">c_s</span> <span class="op">*</span> <span class="va">d_surf_area</span>,</span>
<span>    c_r_lin_p     <span class="op">=</span> <span class="va">c_r_int</span> <span class="op">+</span> <span class="va">c_r_slope</span> <span class="op">*</span> <span class="va">surf_area_1</span>,</span>
<span>    c_r           <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">c_r_lin_p</span><span class="op">)</span>,</span>
<span>    c_s           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">c_s_int</span> <span class="op">+</span> <span class="va">c_s_slope</span> <span class="op">*</span> <span class="va">surf_area_1</span><span class="op">)</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">constant_params</span>,</span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"surf_area"</span>, <span class="st">"sb"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    </span>
<span>    <span class="co"># There is not eviction to correct here, so we can set this to false</span></span>
<span>    </span>
<span>    evict_cor     <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name          <span class="op">=</span> <span class="st">"stay_discrete"</span>,</span>
<span>    family        <span class="op">=</span> <span class="st">"DD"</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">r_s</span> <span class="op">*</span> <span class="va">r_r</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">constant_params</span>,</span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"sb"</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    evict_cor     <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name          <span class="op">=</span> <span class="st">"leave_discrete"</span>,</span>
<span>    family        <span class="op">=</span> <span class="st">"DC"</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">r_d</span> <span class="op">*</span> <span class="va">r_s</span> <span class="op">*</span> <span class="va">c_d</span>,</span>
<span>    c_d           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">surf_area_2</span>, <span class="va">c_d_mu</span>, <span class="va">c_d_sd</span><span class="op">)</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">constant_params</span>,</span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"surf_area"</span>, <span class="st">"sb"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/eviction.html">truncated_distributions</a></span><span class="op">(</span><span class="st">"norm"</span>, <span class="st">"c_d"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_impl</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/define_star.html">make_impl_args_list</a></span><span class="op">(</span></span>
<span>      kernel_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"P_stoch"</span>, </span>
<span>                       <span class="st">"F"</span>,</span>
<span>                       <span class="st">"go_discrete"</span>, </span>
<span>                       <span class="st">"stay_discrete"</span>, </span>
<span>                       <span class="st">"leave_discrete"</span><span class="op">)</span>,</span>
<span>      int_rule     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"midpoint"</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>      state_start  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"surf_area"</span>, </span>
<span>                       <span class="st">"surf_area"</span>,</span>
<span>                       <span class="st">"surf_area"</span>,</span>
<span>                       <span class="st">"sb"</span>, </span>
<span>                       <span class="st">"sb"</span><span class="op">)</span>,</span>
<span>      state_end    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"surf_area"</span>,</span>
<span>                       <span class="st">"surf_area"</span>, </span>
<span>                       <span class="st">"sb"</span>, </span>
<span>                       <span class="st">"sb"</span>, </span>
<span>                       <span class="st">"surf_area"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_domains</a></span><span class="op">(</span></span>
<span>    surf_area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="op">)</span> </span></code></pre></div>
<p>Now, we need to <code><a href="../reference/define_star.html">define_env_state()</a></code>. This consists of two
parts - specifying expressions that generate environmental covariates,
and supplying the information needed to evaluate those expressions. In
this example, we want to use the <code>env_params</code> in
<code>sample_env</code> (i.e. <code>sample_env(env_params)</code>).
<code>define_env_state</code> uses the <code>data_list</code> argument
to supply the <code>env_params</code>, and the call to
<code>sample_env</code> goes into the <code>...</code> portion of the
function. Here, we assign the result to <code>env_covs</code>. The name
<code>env_covs</code> isn’t important for specifying vital rate
expressions and you could call it whatever you want, but it must be
named something in order to work properly. The only thing that needs to
match are the names in the list that <code>sample_env</code> returns,
and the names used in the vital rate expressions/kernels.</p>
<p>Note that you can pass the <code>sample_env</code> function in either
the <code>data_list</code> of <code><a href="../reference/define_star.html">define_env_state()</a></code>, or the
<code>usr_funs</code> argument of <code><a href="../reference/make_ipm.html">make_ipm()</a></code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># In the first version, sample_env is provided in the data_list of </span></span>
<span><span class="co"># define_env_state.</span></span>
<span></span>
<span><span class="va">general_stoch_param_ipm</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/define_star.html">define_env_state</a></span><span class="op">(</span></span>
<span>  proto_ipm  <span class="op">=</span> <span class="va">general_stoch_param_model</span>,</span>
<span>  env_covs   <span class="op">=</span> <span class="fu">sample_env</span><span class="op">(</span><span class="va">env_params</span><span class="op">)</span>,</span>
<span>  data_list  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>env_params <span class="op">=</span> <span class="va">env_params</span>,</span>
<span>                    sample_env <span class="op">=</span> <span class="va">sample_env</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_pop_state</a></span><span class="op">(</span></span>
<span>    n_surf_area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>    n_sb        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span><span class="op">(</span>usr_funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>inv_logit  <span class="op">=</span> <span class="va">inv_logit</span><span class="op">)</span>,</span>
<span>           iterate <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>           iterations <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># in the second version, sample_env is provided in the usr_funs list of </span></span>
<span><span class="co"># make_ipm(). These two versions are equivalent. </span></span>
<span></span>
<span><span class="va">general_stoch_param_ipm</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/define_star.html">define_env_state</a></span><span class="op">(</span></span>
<span>  proto_ipm  <span class="op">=</span> <span class="va">general_stoch_param_model</span>,</span>
<span>  env_covs   <span class="op">=</span> <span class="fu">sample_env</span><span class="op">(</span><span class="va">env_params</span><span class="op">)</span>,</span>
<span>  data_list  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>env_params <span class="op">=</span> <span class="va">env_params</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_pop_state</a></span><span class="op">(</span></span>
<span>    n_surf_area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>    n_sb        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">20</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span><span class="op">(</span>usr_funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>inv_logit  <span class="op">=</span> <span class="va">inv_logit</span>,</span>
<span>                           sample_env <span class="op">=</span> <span class="va">sample_env</span><span class="op">)</span>,</span>
<span>           iterate <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>           iterations <span class="op">=</span> <span class="fl">100</span>,</span>
<span>           return_sub_kernels <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Stochastic parameter-resampled models also return an
<code>env_seq</code>, but this time it will be a <code>data.frame</code>
of parameter draws rather than a character vector. We can also compute
mean sub-kernels and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>λ</mi><mi>s</mi></msub><annotation encoding="application/x-tex">\lambda_s</annotation></semantics></math>
as we did in the kernel-resampled models. This time, each mean kernel is
computed as the average of each sub-kernel over the course of the
simulation (i.e. mean of all <code>P</code> kernels). Some sub-kernels
in our example are not time-varying - they will be numerically
equivalent to the sub-kernels stored in the IPM object.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">env_draws</span>  <span class="op">&lt;-</span> <span class="va">general_stoch_param_ipm</span><span class="op">$</span><span class="va">env_seq</span></span>
<span></span>
<span><span class="va">mean_kerns</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mean_kernel.html">mean_kernel</a></span><span class="op">(</span><span class="va">general_stoch_param_ipm</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lam_s</span>      <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lambda.html">lambda</a></span><span class="op">(</span><span class="va">general_stoch_param_ipm</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">mean_kerns</span><span class="op">$</span><span class="va">mean_F</span>, </span>
<span>          <span class="va">general_stoch_param_ipm</span><span class="op">$</span><span class="va">sub_kernels</span><span class="op">$</span><span class="va">F_it_1</span>,</span>
<span>          check.attributes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="a-note-on-memory-management">A note on memory management<a class="anchor" aria-label="anchor" href="#a-note-on-memory-management"></a>
</h3>
<p>Longer running stochastic parameter-resampled models can take up a
lot of space in memory when all of the sub-kernels are saved from each
iteration. For example, running the model above for 10,000 iterations
would result in 20,000
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mo>×</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">100 \times 100</annotation></semantics></math>
matrices, 20,000
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">1 \times 100</annotation></semantics></math>/<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">100 \times 1</annotation></semantics></math>
matrices, and 10,000
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">1 \times 1</annotation></semantics></math>
matrices in the <code>sub_kernels</code> slot of the IPM object (~16.4
GB of RAM). This will likely result in crashes as smaller machines run
out of available RAM. Therefore, <code><a href="../reference/make_ipm.html">make_ipm()</a></code> contains an
argument <code>return_sub_kernels</code> for these types of models that
allows you to switch off that behavior and conserve available RAM. By
default, this is set to <code>FALSE</code>. If you need sub-kernels for
downstream analyses, set this option to <code>TRUE</code> and make sure
you have a computer with sufficient RAM (64-128 GB range is likely
required to store all information for longer running models).</p>
<p>These warnings also apply to <em>all</em> density dependent model
classes and the same <code>return_sub_kernels</code> argument can be
used for those as well.</p>
</div>
</div>
<div class="section level2">
<h2 id="code-to-construct-mega-kernels">Code to construct mega-kernels<a class="anchor" aria-label="anchor" href="#code-to-construct-mega-kernels"></a>
</h2>
<p>Sometimes, we may want to work with our sub-kernels arranged into a
single block kernel. This isn’t required for any of the code in
<code>ipmr</code>, except for the <code>plot</code> method for
<code>general_di_det</code> IPMs. Other use cases may arise for analyses
not included in this package though, so below is a brief overview of how
to generate those.</p>
<p><code><a href="../reference/make_iter_kernel.html">make_iter_kernel()</a></code> takes an IPM object and a vector of
symbols (for interactive use) or a character version of the expression
(for programming) showing where each sub-kernel should go. It works in
<strong>ROW MAJOR order</strong>. This example will use the model from
the general deterministic example at the top of the article.</p>
<p>First, re-run the model to create the IPM object (if you haven’t
already).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  g_int     <span class="op">=</span> <span class="fl">5.781</span>,</span>
<span>  g_slope   <span class="op">=</span> <span class="fl">0.988</span>,</span>
<span>  g_sd      <span class="op">=</span> <span class="fl">20.55699</span>,</span>
<span>  s_int     <span class="op">=</span> <span class="op">-</span><span class="fl">0.352</span>,</span>
<span>  s_slope   <span class="op">=</span> <span class="fl">0.122</span>,</span>
<span>  s_slope_2 <span class="op">=</span> <span class="op">-</span><span class="fl">0.000213</span>,</span>
<span>  r_r_int   <span class="op">=</span> <span class="op">-</span><span class="fl">11.46</span>,</span>
<span>  r_r_slope <span class="op">=</span> <span class="fl">0.0835</span>,</span>
<span>  r_s_int   <span class="op">=</span> <span class="fl">2.6204</span>,</span>
<span>  r_s_slope <span class="op">=</span> <span class="fl">0.01256</span>,</span>
<span>  r_d_mu    <span class="op">=</span> <span class="fl">5.6655</span>,</span>
<span>  r_d_sd    <span class="op">=</span> <span class="fl">2.0734</span>,</span>
<span>  e_p       <span class="op">=</span> <span class="fl">0.15</span>,</span>
<span>  g_i       <span class="op">=</span> <span class="fl">0.5067</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">L</span> <span class="op">&lt;-</span> <span class="fl">1.02</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="fl">624</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2312</span><span class="op">)</span></span>
<span></span>
<span><span class="va">init_pop_vec</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">init_seed_bank</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span></span>
<span><span class="co"># Initialize the state list and add some helper functions. The survival function</span></span>
<span><span class="co"># in this model is a quadratic function.</span></span>
<span></span>
<span><span class="va">inv_logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">inv_logit_2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">slope_2</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">+</span> <span class="va">slope_2</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">general_ipm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init_ipm.html">init_ipm</a></span><span class="op">(</span>sim_gen    <span class="op">=</span> <span class="st">"general"</span>,</span>
<span>                        di_dd      <span class="op">=</span> <span class="st">"di"</span>, </span>
<span>                        det_stoch  <span class="op">=</span> <span class="st">"det"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name          <span class="op">=</span> <span class="st">"P"</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">s</span> <span class="op">*</span> <span class="va">g</span> <span class="op">*</span> <span class="va">d_ht</span>,</span>
<span>    family        <span class="op">=</span> <span class="st">"CC"</span>,</span>
<span>    g             <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">g_mu</span>, <span class="va">g_sd</span><span class="op">)</span>,</span>
<span>    g_mu          <span class="op">=</span> <span class="va">g_int</span> <span class="op">+</span> <span class="va">g_slope</span> <span class="op">*</span> <span class="va">ht_1</span>,</span>
<span>    s             <span class="op">=</span> <span class="fu">inv_logit_2</span><span class="op">(</span><span class="va">s_int</span>, <span class="va">s_slope</span>, <span class="va">s_slope_2</span>, <span class="va">ht_1</span><span class="op">)</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">data_list</span>,</span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/eviction.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,</span>
<span>                                            <span class="st">'g'</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name          <span class="op">=</span> <span class="st">"go_discrete"</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">r_r</span> <span class="op">*</span> <span class="va">r_s</span> <span class="op">*</span> <span class="va">g_i</span>,</span>
<span>    family        <span class="op">=</span> <span class="st">'CD'</span>,</span>
<span>    r_r           <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">r_r_int</span>, <span class="va">r_r_slope</span>, <span class="va">ht_1</span><span class="op">)</span>,</span>
<span>    r_s           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">r_s_int</span> <span class="op">+</span> <span class="va">r_s_slope</span> <span class="op">*</span> <span class="va">ht_1</span><span class="op">)</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">data_list</span>,</span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name      <span class="op">=</span> <span class="st">'stay_discrete'</span>,</span>
<span>    formula   <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    family    <span class="op">=</span> <span class="st">"DD"</span>,  </span>
<span>    states    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    evict_cor <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name          <span class="op">=</span> <span class="st">'leave_discrete'</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">e_p</span> <span class="op">*</span> <span class="va">r_d</span>,</span>
<span>    r_d           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">r_d_mu</span>, <span class="va">r_d_sd</span><span class="op">)</span>,</span>
<span>    family        <span class="op">=</span> <span class="st">'DC'</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">data_list</span>,</span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/eviction.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,</span>
<span>                                            <span class="st">'r_d'</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_impl</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/define_star.html">make_impl_args_list</a></span><span class="op">(</span></span>
<span>      kernel_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"P"</span>, <span class="st">"go_discrete"</span>, <span class="st">"stay_discrete"</span>, <span class="st">"leave_discrete"</span><span class="op">)</span>,</span>
<span>      int_rule     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"midpoint"</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      state_start    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"ht"</span>, <span class="st">"b"</span>, <span class="st">"b"</span><span class="op">)</span>,</span>
<span>      state_end      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">'ht'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_domains</a></span><span class="op">(</span></span>
<span>    ht <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">L</span>, <span class="va">U</span>, <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_pop_state</a></span><span class="op">(</span></span>
<span>    pop_vectors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_ht <span class="op">=</span> <span class="va">init_pop_vec</span>,</span>
<span>      n_b  <span class="op">=</span> <span class="va">init_seed_bank</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span><span class="op">(</span>iterations <span class="op">=</span> <span class="fl">100</span>,</span>
<span>           usr_funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>inv_logit   <span class="op">=</span> <span class="va">inv_logit</span>,</span>
<span>                           inv_logit_2 <span class="op">=</span> <span class="va">inv_logit_2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now, we specify which kernel belongs where in row major order, using
a call to <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mega_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_iter_kernel.html">make_iter_kernel</a></span><span class="op">(</span>ipm <span class="op">=</span> <span class="va">general_ipm</span>,</span>
<span>                             mega_mat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>                               <span class="va">stay_discrete</span>, <span class="va">go_discrete</span>,</span>
<span>                               <span class="va">leave_discrete</span>, <span class="va">P</span></span>
<span>                             <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># These values should be almost identical, so this should ~0</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/complex.html" class="external-link">Re</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="va">mega_mat</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="../reference/lambda.html">lambda</a></span><span class="op">(</span><span class="va">general_ipm</span><span class="op">)</span></span></code></pre></div>
<p>Say we wanted to program with this function. Passing bare expression
is difficult programatically, and how to do that is not really within
the scope of this vignette (though if you’re interested in learning how,
<a href="https://dplyr.tidyverse.org/articles/programming.html" class="external-link">this</a>
is a good start). <code><a href="../reference/make_iter_kernel.html">make_iter_kernel()</a></code> also accepts text
strings in the same format as above.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the names of each sub_kernel</span></span>
<span><span class="va">sub_k_nms</span>     <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">general_ipm</span><span class="op">$</span><span class="va">sub_kernels</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mega_mat_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">sub_k_nms</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, <span class="va">sub_k_nms</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">sub_k_nms</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, <span class="va">sub_k_nms</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mega_mat_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_iter_kernel.html">make_iter_kernel</a></span><span class="op">(</span><span class="va">general_ipm</span>,</span>
<span>                               mega_mat <span class="op">=</span> <span class="va">mega_mat_text</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Should be TRUE</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">mega_mat</span>, <span class="va">mega_mat_2</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/make_iter_kernel.html">make_iter_kernel()</a></code> can also handle cases where you need
blocks of 0s or identity matrices. These are specified using
<code>0</code> for 0s, and <code>I</code> for identity matrices.
<code><a href="../reference/make_iter_kernel.html">make_iter_kernel()</a></code> automatically works out the correct
dimensions internally, so you don’t need to worry about specifying
those.</p>
<p>Below is an example that inserts 0s and identity matrices on the
off-diagonals with the <code>P</code> kernel duplicated along the
diagonal.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mega_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_iter_kernel.html">make_iter_kernel</a></span><span class="op">(</span><span class="va">general_ipm</span>,</span>
<span>                               mega_mat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">P</span>, <span class="fl">0</span>, </span>
<span>                                            <span class="va">I</span>, <span class="va">P</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Finally, <code>make_iter_kernel</code> supports <code>ipmr</code>’s
parameter set index syntax as well, enabling us to generate a list of
mega-kernels for each combination of parameter set values. We’ll re-run
the <code>"general_di_stoch_kern"</code> example from above to
demonstrate this.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all_g_int</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, mean <span class="op">=</span> <span class="fl">5.781</span>, sd <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">all_f_s_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">5</span>, mean <span class="op">=</span> <span class="fl">2.6204</span>, sd <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">all_g_int</span><span class="op">)</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"g_int_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">all_f_s_int</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"f_s_int_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span></span>
<span><span class="va">constant_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  g_slope   <span class="op">=</span> <span class="fl">0.988</span>,</span>
<span>  g_sd      <span class="op">=</span> <span class="fl">20.55699</span>,</span>
<span>  s_int     <span class="op">=</span> <span class="op">-</span><span class="fl">0.352</span>,</span>
<span>  s_slope   <span class="op">=</span> <span class="fl">0.122</span>,</span>
<span>  s_slope_2 <span class="op">=</span> <span class="op">-</span><span class="fl">0.000213</span>,</span>
<span>  f_r_int   <span class="op">=</span> <span class="op">-</span><span class="fl">11.46</span>,</span>
<span>  f_r_slope <span class="op">=</span> <span class="fl">0.0835</span>,</span>
<span>  f_s_slope <span class="op">=</span> <span class="fl">0.01256</span>,</span>
<span>  f_d_mu    <span class="op">=</span> <span class="fl">5.6655</span>,</span>
<span>  f_d_sd    <span class="op">=</span> <span class="fl">2.0734</span>,</span>
<span>  e_p       <span class="op">=</span> <span class="fl">0.15</span>,</span>
<span>  g_i       <span class="op">=</span> <span class="fl">0.5067</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">all_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">constant_list</span>, <span class="va">all_g_int</span>, <span class="va">all_f_s_int</span><span class="op">)</span></span>
<span></span>
<span><span class="va">L</span> <span class="op">&lt;-</span> <span class="fl">1.02</span></span>
<span><span class="va">U</span> <span class="op">&lt;-</span> <span class="fl">624</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2312</span><span class="op">)</span></span>
<span></span>
<span><span class="va">init_pop_vec</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">init_seed_bank</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span></span>
<span><span class="va">inv_logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">inv_logit_2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">int</span>, <span class="va">slope</span>, <span class="va">slope_2</span>, <span class="va">sv</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">int</span> <span class="op">+</span> <span class="va">slope</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">+</span> <span class="va">slope_2</span> <span class="op">*</span> <span class="va">sv</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">general_stoch_kern_ipm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/init_ipm.html">init_ipm</a></span><span class="op">(</span>sim_gen    <span class="op">=</span> <span class="st">"general"</span>,</span>
<span>                                   di_dd      <span class="op">=</span> <span class="st">"di"</span>, </span>
<span>                                   det_stoch  <span class="op">=</span> <span class="st">"stoch"</span>,</span>
<span>                                   kern_param <span class="op">=</span> <span class="st">"kern"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name          <span class="op">=</span> <span class="st">"P_year"</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">s</span> <span class="op">*</span> <span class="va">g_year</span> <span class="op">*</span> <span class="va">d_ht</span>,</span>
<span>    family        <span class="op">=</span> <span class="st">"CC"</span>,</span>
<span>    g_year           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">g_mu_year</span>, <span class="va">g_sd</span><span class="op">)</span>,</span>
<span>    g_mu_year        <span class="op">=</span> <span class="va">g_int_year</span> <span class="op">+</span> <span class="va">g_slope</span> <span class="op">*</span> <span class="va">ht_1</span>,</span>
<span>    s                <span class="op">=</span> <span class="fu">inv_logit_2</span><span class="op">(</span><span class="va">s_int</span>, <span class="va">s_slope</span>, <span class="va">s_slope_2</span>, <span class="va">ht_1</span><span class="op">)</span>,</span>
<span>    data_list        <span class="op">=</span> <span class="va">all_params</span>,</span>
<span>    states           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets    <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    par_set_indices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>    evict_cor        <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    evict_fun        <span class="op">=</span> <span class="fu"><a href="../reference/eviction.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,</span>
<span>                                               <span class="st">'g_year'</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name          <span class="op">=</span> <span class="st">"go_discrete_year"</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">f_r</span> <span class="op">*</span> <span class="va">f_s_year</span> <span class="op">*</span> <span class="va">g_i</span> <span class="op">*</span> <span class="va">d_ht</span>,</span>
<span>    family        <span class="op">=</span> <span class="st">'CD'</span>,</span>
<span>    f_r           <span class="op">=</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">f_r_int</span>, <span class="va">f_r_slope</span>, <span class="va">ht_1</span><span class="op">)</span>,</span>
<span>    f_s_year      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">f_s_int_year</span> <span class="op">+</span> <span class="va">f_s_slope</span> <span class="op">*</span> <span class="va">ht_1</span><span class="op">)</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">all_params</span>,</span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets    <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    par_set_indices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name    <span class="op">=</span> <span class="st">'stay_discrete'</span>,</span>
<span>    formula <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    family  <span class="op">=</span> <span class="st">"DD"</span>,</span>
<span>    states  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'b'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    evict_cor <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/kernel-definitions.html">define_kernel</a></span><span class="op">(</span></span>
<span>    name          <span class="op">=</span> <span class="st">'leave_discrete'</span>,</span>
<span>    formula       <span class="op">=</span> <span class="va">e_p</span> <span class="op">*</span> <span class="va">f_d</span> <span class="op">*</span> <span class="va">d_ht</span>,</span>
<span>    f_d           <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">ht_2</span>, <span class="va">f_d_mu</span>, <span class="va">f_d_sd</span><span class="op">)</span>,</span>
<span>    family        <span class="op">=</span> <span class="st">'DC'</span>,</span>
<span>    data_list     <span class="op">=</span> <span class="va">all_params</span>,</span>
<span>    states        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    uses_par_sets <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    evict_cor     <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    evict_fun     <span class="op">=</span> <span class="fu"><a href="../reference/eviction.html">truncated_distributions</a></span><span class="op">(</span><span class="st">'norm'</span>,</span>
<span>                                            <span class="st">'f_d'</span><span class="op">)</span></span>
<span>  <span class="op">)</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_impl</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/define_star.html">make_impl_args_list</a></span><span class="op">(</span></span>
<span>      kernel_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"P_year"</span>, <span class="st">"go_discrete_year"</span>, <span class="st">"stay_discrete"</span>, <span class="st">"leave_discrete"</span><span class="op">)</span>,</span>
<span>      int_rule     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"midpoint"</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      state_start    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"ht"</span>, <span class="st">"b"</span>, <span class="st">"b"</span><span class="op">)</span>,</span>
<span>      state_end      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'ht'</span>, <span class="st">"b"</span>, <span class="st">"b"</span>, <span class="st">'ht'</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_domains</a></span><span class="op">(</span></span>
<span>    ht <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">L</span>, <span class="va">U</span>, <span class="va">n</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/define_star.html">define_pop_state</a></span><span class="op">(</span></span>
<span>      n_ht <span class="op">=</span> <span class="va">init_pop_vec</span>,</span>
<span>      n_b  <span class="op">=</span> <span class="va">init_seed_bank</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/make_ipm.html">make_ipm</a></span><span class="op">(</span></span>
<span>    iterations <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    kernel_seq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, size <span class="op">=</span> <span class="fl">10</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    usr_funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>inv_logit   <span class="op">=</span> <span class="va">inv_logit</span>,</span>
<span>                    inv_logit_2 <span class="op">=</span> <span class="va">inv_logit_2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Next, we call <code><a href="../reference/make_iter_kernel.html">make_iter_kernel()</a></code> using the kernel names
like so:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">block_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_iter_kernel.html">make_iter_kernel</a></span><span class="op">(</span><span class="va">general_stoch_kern_ipm</span>,</span>
<span>                                 mega_mat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stay_discrete</span>, <span class="va">go_discrete_year</span>,</span>
<span>                                              <span class="va">leave_discrete</span>, <span class="va">P_year</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/make_iter_kernel.html">make_iter_kernel()</a></code> also works for simple models, but
assumes that all sub-kernels are combined additively
(i.e. <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mi>′</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mi>F</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>′</mi><mi>z</mi><mo>,</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">K(z',z) = P(z',z) + F('z,z)</annotation></semantics></math>).
It can handle parameter set index syntax as well, but does not require
the <code>mega_mat</code> argument, and can just be called with an IPM
object.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://github.com/levisc8" class="external-link">Sam Levin</a>, Aldo Compagnoni, Dylan Childs, Sanne Evers, Roberto Salguero-Gomez, Tiffany Knight.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
